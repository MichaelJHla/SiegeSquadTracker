<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="https://use.typekit.net/huf3guc.css">
    <title>Siege Squad Tracker</title>
</head>

<body>
    <div id="header">
        <h1 id="squad-name">No Squad</h1>
        <div id="nav-elements">
            <h2><a href="map-bans.html">Map Ban Helper</a></h2>
            <h2><a href="operator-bans.html">Operator Bans</a></h2>
            <h2><a href="site-stats.html">Site Stat Tracker</a></h2>
        </div>
    </div>

    <div id="no-squad">
        <form id="join-squad-form">
            <h3>Create or join a squad</h1>

            <label for="squad">Squad name</label>
            <input id="squad">

            <label for="squad-password">Squad password</label>
            <input type="password" id="squad-password">

            <input type="submit" id="join-squad-button">
        </form>
    </div>

    <div id="squad-data">
        
    </div>

    <div id="footer-div">
        <footer><!--This will tell the user who they are signed in as--></footer>
        <button id="sign-out-button" onclick="signOut()">Sign Out</button>
    </div>

    <!--All scripts below here-->
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-app.js"></script>
    <!-- Database CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-database.js"></script>
    <!-- Authentication CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.1.1/firebase-auth.js"></script>
    <!--Configuration information for firebase-->
    <script src="../scripts/firebaseConfig.js"></script>
    <!--jQuery import-->
    <script src="../scripts/jquery.js"></script>

    <script>
        //Get the current status of the user's login
        auth.onAuthStateChanged(user => {
            if (!user) { //If a user is not logged in
                window.location.replace("../index.html");
            }
        });

        function signOut() {
            auth.signOut().then(() => {
                localStorage.removeItem("squadname");
                localStorage.removeItem("userid");
            });
        }

        database.ref("users/" + localStorage.getItem("userid")).once('value').then(function(snapshot) {
            $('footer').text("Signed in as " + snapshot.val().username);
            var squad = snapshot.val().squad;
            if (squad) { //If the user is part of a squad
                console.log("Squad found: " + squad);
            } else { //If the user is not part of a squad
                console.log("No squad found");
            }
        });

        var joinSquadForm = document.querySelector("#join-squad-form");
        joinSquadForm.addEventListener('submit', (e) => {
            e.preventDefault();

            database.ref("squads").once('value').then(function(snapshot) {
                var squad = $('#squad').val();
                var squadPassword = $('#squad-password').val();
                var squadList = Object.keys(snapshot.val());
                console.log(squadList);
                if (squadList.includes(squad)) {//If this squad exists
                    if (squadPassword == snapshot.val()[squad].password) { //If the password is correct
                        if (window.confirm("Would you like to join the squad " + squad + "?")) { //If the user confirms to join the squad
                            database.ref("users/" + localStorage.getItem("userid") + "/squad").set(squad);
                            database.ref("users/" + localStorage.getItem("userid") + "/username").once('value').then(function(snapshot) {
                                database.ref("squads/" + squad + "/members/" + localStorage.getItem("userid")).set(snapshot.val());
                            });
                            localStorage.setItem("squadname", squad);
                        }
                    } else { //If the password is not correct

                    }
                } else {//If this squad does not exist
                    console.log("This squad does not exist");
                }
            });
        });
    </script>
</body>